---
title: 蜗牛星际折腾记
date: 2019-10-07 18:52:25
categories:
tags:
---
## 花费
蜗牛星际B款双网口 ￥338
三星PM851 120G msata固态硬盘 ￥140
西部数据机械硬盘 2T*2 ￥533
绿联千兆网线 ￥67.8+￥54
3pin风扇减速线 ￥8
合计：￥1140.8
北京联通300M宽带1年 ￥1072/3
可能还需要一个千兆交换机

## 背景
蜗牛买回来，msata就是坏的了，基本不能识别
蜗牛安装好了pve，在pve上装好了iKuai、LEDE(openwrt)和群晖(DS3617XS)
两块机械硬盘直通给了群晖

## 网络拓扑
－－－光猫（路由模式）－－－TP-link路由器－－－K2P路由器－－－PC
三级NAT：光猫通过拨号获取公网IP，TP-link通过DHCP获取IP，K2P通过DHCP获取IP
光猫中只有LAN1是千兆口，其他三个LAN口都是百兆口

## 测速
1、百兆网线VS千兆网线
在泰联做的网线是百兆的（莫非是八条线中有没接上的？）
之前买东西送的一个质量很差的网线是千兆的。
![](speedtest.jpg)
2、多级NAT降低了网速？实际上没有。
在光猫后测试，下载速度将近400Mbps,上传速度大约45Mbps。
在TP-link后测试，下载速度将近100Mbps,上传速度大约45Mbps。(tplink应该是百兆的)
而在K2P后测试，上传下载只有20左右；把K2P接到光猫后也是这个结果。
a. K2P不是千兆的？
错，K2P每个口都是千兆的，是千兆路由器。（再说，百兆路由器也应该跑出来100才对
b. 高恪的固件问题？（记得之前用官方固件和官改，网速都很流畅。
错，固件没有问题。仔细排查了一下，实际是因为外网配置中只使用了虚拟接口，没有使用物理接口。

## 设置外网访问群晖管理网址
方案：DDNS + 端口映射（联通给了公网IP
### DDNS
域名是之前买的阿里云的。DDNS采用群晖中的docker，搜索下载aliyun-ddns的镜像，配置一下环境变量即可。
#### 原理
定时获取联通分配的公网IP，报告给阿里云。阿里云将该记录记录下来。
#### 环境变量
AKID 用户名　　这个从阿里云官网生成获得。
AKSCT 密码　　要向阿里云证明你是你，才能说明你的消息是真的。
REDO 时间间隔(300) 每个五分钟报告一次
DOMAIN dsm.xianglee.top 域名
### 多级端口映射
#### K2P中
![](k2p.1.jpg)
#### TP-link中
![](tplink.jpg)
#### 光猫中
![](modem.jpg)
坑:前两个配置好，内网访问都没问题。光猫配置了，用公网和对应端口始终打不开。
原来是要用外网（手机流量）才能打开！！！
（一度怀疑北京联通对光猫或者端口做了限制。最后如果没搞定的话，还要打联通客服把光猫改成桥接模式，再买一个千兆路由器拨号。)
reference
https://blog.csdn.net/u012911347/article/details/81176448

### 网址
http://dsm.xianglee.top:5000

## TODO
1、待长网线到了，K2P直连光猫
2、多级NAT导致群晖ed2k是low ID。（还是需要多级端口映射？
3、外网也能访问的视频库

## 其他
老爸说家里网变慢了。慢了好久了，没流量快。我就测了一下。
使用无线测试的
![](wireless.jpg)
使用有线测试的
![](wired.jpg)
印象中是50M免费升级到了100M，上行是8M的。
我把路由器中的去广告插件打开或者关闭，对测速没啥影响。
（然而，现在的去广告也不好用了。）
说头条打开慢，还是搜索慢？这是为什么呢？

